// Generated by CoffeeScript 1.6.3
var TreeController;

TreeController = function($scope, $http, $rootScope) {
  var ws;
  isConnected();
  $scope.settings = window.settings;
  $scope.nodes = NodeStorage.nodes;
  $scope.loadChildren = function(name) {
    if (name === "/") {
      name = "";
    }
    return $http.get(window.settings.connection + "/0/children" + name + "/").success(function(data) {
      var element, _i, _len;
      for (_i = 0, _len = data.length; _i < _len; _i++) {
        element = data[_i];
        new Node("/" + element.name, element.type, !element.leaf);
      }
      return $scope.nodes = NodeStorage.nodes;
    });
  };
  $scope.removeNode = function(node) {
    node["delete"]();
    return $scope.nodes = NodeStorage.nodes;
  };
  $scope.addNode = function(node) {
    var name, suffix, typeFull;
    suffix = prompt("Name of new node");
    if (!suffix) {
      return;
    }
    name = node.name + "/" + suffix;
    if (type === "e") {
      typeFull = "ephemeral";
    }
    if (type === "p") {
      typeFull = "persistent";
    }
    return $http({
      url: window.settings.connection + "/0/node" + name + "/",
      method: "PUT",
      data: JSON.stringify({
        "type": typeFull
      }),
      headers: {
        'Content-Type': 'application/json'
      }
    }).success(function() {
      node.createChild(suffix, "p");
      return $scope.nodes = NodeStorage.nodes;
    });
  };
  $scope.nodeClick = function() {
    return $rootScope.$broadcast('closeEditMode');
  };
  $scope.showHideChildren = function(node) {
    if (node.hasChildrens) {
      node.deleteChildren();
    } else {
      $scope.loadChildren(node.name);
    }
    return $scope.nodes = NodeStorage.nodes;
  };
  $scope.loadChildren("/");
  $scope.nodes = NodeStorage.nodes;
  ws = new WebSocket(window.settings.wsConnection + "/0/notify/");
  ws.onerror = function(event) {
    return console.log(event);
  };
  ws.onmessage = function(event) {
    var data;
    console.log(event);
    data = JSON.parse(event.data);
    return $scope.$apply(function(scope) {
      var element, node, path;
      path = data.path;
      if (path.charAt(path.length - 1) !== '/') {
        path = path + '/';
      }
      if (data.add) {
        element = data.add;
        new Node(path + element.name, element.type, !element.leaf);
      }
      if (data["delete"]) {
        node = new Node(path + data["delete"]);
        node["delete"]();
      }
      return $scope.nodes = NodeStorage.nodes;
    });
  };
  ws.onopen = function(event) {
    var tmp;
    tmp = {
      watch: 'true',
      path: '/',
      type: 'CHILDREN'
    };
    return ws.send(JSON.stringify(tmp));
  };
  return ws.onclose = function(event) {
    return console.log(event);
  };
};
